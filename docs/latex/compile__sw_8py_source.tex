\hypertarget{compile__sw_8py_source}{}\doxysection{compile\+\_\+sw.\+py}
\label{compile__sw_8py_source}\index{Projects/PROLEAD/inc/Software/compile\_sw.py@{Projects/PROLEAD/inc/Software/compile\_sw.py}}
\mbox{\hyperlink{compile__sw_8py}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00001}\mbox{\hyperlink{namespacecompile__sw}{00001}}\ \textcolor{keyword}{from}\ asyncio\ \textcolor{keyword}{import}\ subprocess}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00002}00002\ \textcolor{keyword}{import}\ subprocess\ \textcolor{keyword}{as}\ sub}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00003}00003\ \textcolor{keyword}{import}\ os}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00004}00004\ \textcolor{keyword}{import}\ sys}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00005}00005\ \textcolor{keyword}{import}\ shutil}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00006}00006\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00007}00007\ \textcolor{keyword}{from}\ pkg\_resources\ \textcolor{keyword}{import}\ BINARY\_DIST}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00008}00008\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00009}\mbox{\hyperlink{namespacecompile__sw_a997482e8c119302858e8092f53e1664d}{00009}}\ dir\ =\ os.getcwd()}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00010}00010\ sys.path.append(dir)}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00011}00011\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00012}00012\ \textcolor{keyword}{from}\ pathlib\ \textcolor{keyword}{import}\ Path}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00013}\mbox{\hyperlink{namespacecompile__sw_a0a80d26d981f74fc74a7351ec1f37713}{00013}}\ path\ =\ Path(dir)}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00014}00014\ sys.path.append(str(path.parent.absolute()))}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00016}\mbox{\hyperlink{namespacecompile__sw_a914e0d89a7b6e89fc99a64231b902297}{00016}}\ BINARY\_PATH\ =\ \textcolor{stringliteral}{"{}./"{}}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00017}00017\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00018}00018\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00019}00019\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00020}00020\ \textcolor{comment}{\#\ \ \ check\ if\ directory\ exists}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00021}00021\ \textcolor{keywordflow}{if}\ \textcolor{keywordflow}{not}\ os.path.isdir(BINARY\_PATH):}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00022}00022\ \ \ \ \ print(\textcolor{stringliteral}{"{}\(\backslash\)n\{\}\ is\ not\ a\ directory"{}}.format(BINARY\_PATH))}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00023}00023\ \ \ \ \ exit(1)}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00024}00024\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00025}00025\ \textcolor{comment}{\#\ \ \ if\ leftovers\ from\ past\ executions\ exist\ remove\ them}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00026}\mbox{\hyperlink{namespacecompile__sw_afda43d881391ef01f402c67d5cfae33f}{00026}}\ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00027}00027\ \ \ \ \ shutil.rmtree(BINARY\_PATH\ +\ \textcolor{stringliteral}{"{}tmp\_data/"{}})}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00028}00028\ \textcolor{keywordflow}{except}\ FileNotFoundError:}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00029}00029\ \ \ \ \ \textcolor{keywordflow}{pass}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00030}00030\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00031}00031\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00032}00032\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00033}00033\ \textcolor{keywordflow}{try}:}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00034}00034\ \ \ \ \ \textcolor{comment}{\#\ dir\ for\ tmp\ data}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00035}\mbox{\hyperlink{namespacecompile__sw_a6da013fcef134b1e1d6c9e799e142f4b}{00035}}\ \ \ \ \ os.makedirs(BINARY\_PATH\ +\ \textcolor{stringliteral}{"{}tmp\_data/"{}},\ exist\_ok=\textcolor{keyword}{True})}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00036}00036\ \ \ \ \ if(sys.argv[-\/1]\ ==\ \textcolor{stringliteral}{'0'}):}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00037}00037\ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00038}\mbox{\hyperlink{namespacecompile__sw_a5fe3afcb86feab66edc5282527eb9c9d}{00038}}\ \ \ \ \ \ \ \ \ LINKER\_PATH\ =\ sys.argv[1]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00039}00039\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00040}00040\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#generate\ source\ file\ list\ for\ gcc\ call}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00041}\mbox{\hyperlink{namespacecompile__sw_ab1a75e42f365c97e7f756a5c55a26c51}{00041}}\ \ \ \ \ \ \ \ \ source\_file\_args\ =\ \textcolor{stringliteral}{"{}"{}}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00042}00042\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ arg\_idx\ \textcolor{keywordflow}{in}\ range(2,\ len(sys.argv[:-\/1])\ -\/\ 1):}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00043}00043\ \ \ \ \ \ \ \ \ \ \ \ \ source\_file\_args\ +=\ (sys.argv[arg\_idx])}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00044}00044\ \ \ \ \ \ \ \ \ \ \ \ \ source\_file\_args\ +=\ \textcolor{stringliteral}{"{}\ "{}}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00045}00045\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00046}\mbox{\hyperlink{namespacecompile__sw_a5ed74c239168f3dccfee21638b11ddcb}{00046}}\ \ \ \ \ \ \ \ \ compiler\_flags\ =\ sys.argv[len(sys.argv)\ -\/\ 2]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00047}00047\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#\ build\ the\ ARM\ binary}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00048}00048\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ os.system(\textcolor{stringliteral}{"{}arm-\/none-\/eabi-\/gcc\ "{}}\ +\ compiler\_flags\ +\ \textcolor{stringliteral}{"{}\ -\/Wl,-\/T"{}}\ +\ LINKER\_PATH\ +\textcolor{stringliteral}{"{}\ -\/Wl,-\/Map,"{}}\ +\ BINARY\_PATH\ +\ \textcolor{stringliteral}{"{}tmp\_data/binary.map"{}}\ +\ \textcolor{stringliteral}{"{}\ -\/o\ "{}}\ +\ BINARY\_PATH\ +\ \textcolor{stringliteral}{"{}tmp\_data/binary.elf\ "{}}\ +\ source\_file\_args)\ !=\ 0:\ sys.exit(1)}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00049}\mbox{\hyperlink{namespacecompile__sw_a71c29167e511f6d7948d205895fac7fa}{00049}}\ \ \ \ \ \textcolor{keywordflow}{else}:}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00050}\mbox{\hyperlink{namespacecompile__sw_a2e0065814ea038e5d32558986f59e335}{00050}}\ \ \ \ \ \ \ \ \ map\_path\ =\ sys.argv[-\/3]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00051}\mbox{\hyperlink{namespacecompile__sw_a3acc76bc6fa652bd932b0f0e60a16c82}{00051}}\ \ \ \ \ \ \ \ \ disassembled\_path\ =\ sys.argv[-\/2]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00052}\mbox{\hyperlink{namespacecompile__sw_acf6432b1261e786390182dc0ca9c153a}{00052}}\ \ \ \ \ \ \ \ \ elf\_path\ =\ sys.argv[-\/4]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00053}00053\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00054}\mbox{\hyperlink{namespacecompile__sw_ad8b766cbe26bbb0d1ae796b405b2c6fe}{00054}}\ \ \ \ \ \ \ \ \ map\_name\ =\ map\_path.rsplit(\textcolor{stringliteral}{"{}/"{}},\ 1)[-\/1]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00055}\mbox{\hyperlink{namespacecompile__sw_adb516d414a77e5cc50a8bcd44c9b238e}{00055}}\ \ \ \ \ \ \ \ \ disassembled\_name\ =\ disassembled\_path.rsplit(\textcolor{stringliteral}{"{}/"{}},\ 1)[-\/1]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00056}\mbox{\hyperlink{namespacecompile__sw_ac9033c57042928cbbfd54f8a2242e422}{00056}}\ \ \ \ \ \ \ \ \ elf\_name\ =\ \ elf\_path.rsplit(\textcolor{stringliteral}{"{}/"{}},\ 1)[-\/1]}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00057}00057\ \ \ \ \ \ \ \ \ \textcolor{comment}{\#copy\ to\ tmp\_data\ directory}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00058}00058\ \ \ \ \ \ \ \ \ shutil.copyfile(map\_path,\ \textcolor{stringliteral}{"{}tmp\_data/binary.map"{}})}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00059}00059\ \ \ \ \ \ \ \ \ shutil.copyfile(disassembled\_path,\ \textcolor{stringliteral}{"{}tmp\_data/disassembled.txt"{}})}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00060}00060\ \ \ \ \ \ \ \ \ shutil.copyfile(elf\_path,\ \textcolor{stringliteral}{"{}tmp\_data/binary.elf"{}})}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00063}00063\ \textcolor{keywordflow}{except}\ Exception\ \textcolor{keyword}{as}\ e:}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00064}00064\ \ \ \ \ shutil.rmtree(BINARY\_PATH\ +\ \textcolor{stringliteral}{"{}tmp\_data/"{}})}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00065}00065\ \ \ \ \ print(str(e))}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00066}00066\ \ \ \ \ print(\textcolor{stringliteral}{"{}\(\backslash\)nFile\ or\ directory\ to\ program\ file\ not\ found"{}})}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00067}00067\ \ \ \ \ exit(1)}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00068}00068\ }
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00069}00069\ \textcolor{comment}{\#\ create\ disassembly\ for\ looking\ up\ armory\ results\ later}}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00070}00070\ \textcolor{keywordflow}{if}\ os.system(\textcolor{stringliteral}{"{}arm-\/none-\/eabi-\/objdump\ "{}}\ +\ BINARY\_PATH\ +\ \textcolor{stringliteral}{"{}tmp\_data/binary.elf\ -\/d\ >\ "{}}\ +\ BINARY\_PATH\ +\ \textcolor{stringliteral}{"{}tmp\_data/disassembled.txt"{}})\ !=\ 0:\ sys.exit(1)}
\DoxyCodeLine{\Hypertarget{compile__sw_8py_source_l00071}00071\ }

\end{DoxyCode}
